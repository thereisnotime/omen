---
# Audit Framework Hardening Tasks

- name: Install auditd
  ansible.builtin.apt:
    name: auditd
    state: present
    update_cache: true

- name: Backup audit rules
  ansible.builtin.copy:
    src: /etc/audit/rules.d/audit.rules
    dest: "{{ omen_backup_dir }}/audit.rules.{{ ansible_date_time.iso8601_basic_short }}"
    remote_src: true
    mode: '0600'
  when: omen_backup_configs
  ignore_errors: true

- name: Create OMEN audit rules file
  ansible.builtin.template:
    src: audit-rules.j2
    dest: /etc/audit/rules.d/omen-hardening.rules
    mode: '0640'
  notify: restart_auditd

- name: Generate audit rules file content
  ansible.builtin.copy:
    dest: /etc/audit/rules.d/omen-hardening.rules
    content: |
      # OMEN Security Audit Rules
      # Generated by LSHC
      
      # Delete all previous rules
      -D
      
      # Buffer size
      -b 8192
      
      # Failure mode (0=silent 1=printk 2=panic)
      -f 1
      
      {% for rule in omen_auditd_rules %}
      {{ rule }}
      {% endfor %}
      
      # Make configuration immutable (requires reboot to change)
      # -e 2
    mode: '0640'
  notify: restart_auditd

- name: Enable auditd service
  ansible.builtin.service:
    name: auditd
    state: started
    enabled: true

- name: Audit framework hardening complete
  ansible.builtin.debug:
    msg: "Audit framework configuration applied"

